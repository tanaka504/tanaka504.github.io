<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Round Generator</title>
  <!-- Bootstrap 5 CDN -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
  --primary-color: #4e73df;
  --secondary-color: #1cc88a;
  --accent-color: #f6c23e;
  --danger-color: #e74a3b;
  --dark-color: #5a5c69;
  --light-color: #f8f9fc;
  --border-radius: 0.35rem;
  --card-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
  --transition-speed: 0.3s;
}

body {
  font-family: 'Poppins', sans-serif;
  background: linear-gradient(to right, #f8f9fa, #e9ecef);
  padding: 0;
  color: var(--dark-color);
}

.app-container {
  min-height: 100vh;
  padding: 1rem;
}

.header-section {
  background: white;
  padding: 1.5rem;
  border-radius: var(--border-radius);
  box-shadow: var(--card-shadow);
  margin-bottom: 1.5rem;
  position: relative;
  overflow: hidden;
}

.header-section::before {
  content: "";
  position: absolute;
  top: 0;
  left: 0;
  width: 8px;
  height: 100%;
  background: var(--primary-color);
}

h1 {
  font-weight: 700;
  color: var(--primary-color);
  margin-bottom: 1rem;
  position: relative;
  display: inline-block;
  font-size: 1.75rem;
}

h1::after {
  content: "";
  position: absolute;
  left: 0;
  bottom: -8px;
  width: 50px;
  height: 4px;
  background: var(--secondary-color);
  border-radius: 2px;
}

.config-card {
  background: white;
  border-radius: var(--border-radius);
  box-shadow: var(--card-shadow);
  padding: 1.25rem;
  margin-bottom: 1.5rem;
  transition: transform var(--transition-speed);
}

.config-card:hover {
  transform: translateY(-2px);
}

.form-label {
  font-weight: 500;
  color: var(--dark-color);
  font-size: 0.9rem;
}

.form-control {
  border-radius: var(--border-radius);
  padding: 0.75rem 1rem;
  border: 1px solid #e3e6f0;
  transition: all var(--transition-speed);
  font-size: 1rem;
}

.form-control:focus {
  border-color: var(--primary-color);
  box-shadow: 0 0 0 0.25rem rgba(78, 115, 223, 0.25);
}

.input-group-text {
  background-color: #f8f9fc;
  border-color: #e3e6f0;
  font-size: 0.9rem;
}

.btn {
  border-radius: var(--border-radius);
  padding: 0.75rem 1.5rem;
  font-weight: 600;
  transition: all var(--transition-speed);
  font-size: 0.95rem;
}

.btn-primary {
  background-color: var(--primary-color);
  border-color: var(--primary-color);
}

.btn-primary:hover {
  background-color: #2e59d9;
  border-color: #2653d4;
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(46, 89, 217, 0.2);
}

.btn-secondary {
  background-color: var(--dark-color);
  border-color: var(--dark-color);
}

.btn-secondary:hover {
  background-color: #484b58;
  border-color: #444752;
}

.btn-icon {
  margin-right: 8px;
}

.results-card {
  background: white;
  border-radius: var(--border-radius);
  box-shadow: var(--card-shadow);
  padding: 0;
  overflow: hidden;
  opacity: 0;
  transform: translateY(20px);
  transition: all 0.5s ease;
}

.results-card.show {
  opacity: 1;
  transform: translateY(0);
}

.results-header {
  background: var(--primary-color);
  color: white;
  padding: 1rem 1.25rem;
  font-weight: 600;
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 0.5rem;
}

.stats-container {
  display: flex;
  flex-wrap: wrap;
  padding: 1rem;
  background: #f8f9fc;
  border-bottom: 1px solid #e3e6f0;
}

.stat-card {
  flex: 1;
  min-width: 150px;
  background: white;
  border-radius: var(--border-radius);
  box-shadow: 0 2px 5px rgba(0,0,0,0.05);
  padding: 0.75rem;
  margin: 0.25rem;
  text-align: center;
  border-left: 4px solid var(--primary-color);
}

.stat-card.primary { border-left-color: var(--primary-color); }
.stat-card.success { border-left-color: var(--secondary-color); }
.stat-card.warning { border-left-color: var(--accent-color); }
.stat-card.danger { border-left-color: var(--danger-color); }

.stat-title {
  font-size: 0.75rem;
  text-transform: uppercase;
  letter-spacing: 1px;
  color: #858796;
  margin-bottom: 0.25rem;
}

.stat-value {
  font-size: 1.25rem;
  font-weight: 700;
  color: var(--dark-color);
}

.table-container {
  padding: 0.5rem;
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
}

.table {
  margin-bottom: 0;
  border-collapse: separate;
  border-spacing: 0;
  min-width: 600px;
}

.table thead th {
  background-color: #f8f9fc;
  border-bottom: 1px solid #e3e6f0;
  font-weight: 600;
  color: #6e707e;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  font-size: 0.75rem;
  padding: 0.75rem 0.5rem;
  white-space: nowrap;
}

.table tbody tr {
  transition: all var(--transition-speed);
}

.table tbody tr:hover {
  background-color: rgba(78, 115, 223, 0.05);
}

.table tbody td {
  padding: 0.75rem 0.5rem;
  vertical-align: middle;
  border-top: 1px solid #e3e6f0;
}

.round-badge {
  background: var(--primary-color);
  color: white;
  border-radius: 50px;
  padding: 0.25rem 0.75rem;
  font-weight: 600;
  display: inline-block;
  font-size: 0.8rem;
}

.court-badge {
  background: #f1f1f1;
  color: var(--dark-color);
  border-radius: 3px;
  padding: 0.25rem 0.5rem;
  font-size: 0.8rem;
  white-space: nowrap;
}

.team-container {
  display: flex;
  align-items: center;
  justify-content: flex-end;
}

.team-container.right {
  justify-content: flex-start;
}

.team-label {
  background: #e8f0fe;
  color: var(--primary-color);
  border-radius: 3px;
  padding: 0.25rem 0.5rem;
  font-weight: 600;
  font-size: 0.85rem;
  white-space: nowrap;
}

.vs-badge {
  background: #f8f9fc;
  width: 30px;
  height: 30px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 600;
  color: var(--dark-color);
  margin: 0 0.5rem;
  box-shadow: 0 2px 5px rgba(0,0,0,0.05);
  font-size: 0.7rem;
  flex-shrink: 0;
}

.call-checkbox {
  transform: scale(1.2);
  accent-color: var(--primary-color);
  cursor: pointer;
}

.completed td {
  opacity: 0.5;
  text-decoration: line-through;
}

.loading-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(255, 255, 255, 0.8);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  opacity: 0;
  visibility: hidden;
  transition: all 0.3s;
}

.loading-overlay.show {
  opacity: 1;
  visibility: visible;
}

.spinner {
  width: 50px;
  height: 50px;
  border: 5px solid rgba(78, 115, 223, 0.2);
  border-top-color: var(--primary-color);
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.empty-state {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 2rem 1rem;
  text-align: center;
}

.empty-icon {
  font-size: 3rem;
  color: #d1d3e2;
  margin-bottom: 1rem;
}

.empty-text {
  font-size: 1rem;
  color: #858796;
  margin-bottom: 1rem;
  line-height: 1.5;
}

.alert {
  border-radius: var(--border-radius);
  padding: 1rem 1.25rem;
  margin-bottom: 1.5rem;
  border: none;
}

.alert-danger {
  background-color: #f8d7da;
  color: #721c24;
  border-left: 4px solid var(--danger-color);
}

.alert-icon {
  margin-right: 0.5rem;
}

.tooltip-icon {
  margin-left: 5px;
  font-size: 0.8rem;
  color: #858796;
  cursor: help;
}

/* モバイル対応のメディアクエリ */
@media (max-width: 768px) {
  .app-container {
    padding: 0.5rem;
  }
  
  .header-section {
    padding: 1rem;
    margin-bottom: 1rem;
  }
  
  h1 {
    font-size: 1.5rem;
  }
  
  .config-card {
    padding: 1rem;
    margin-bottom: 1rem;
  }
  
  .btn {
    width: 100%;
    margin-top: 0.5rem;
    padding: 0.875rem 1rem;
    font-size: 1rem;
  }
  
  .btn:first-child {
    margin-top: 1rem;
  }
  
  .results-header {
    padding: 0.75rem 1rem;
    flex-direction: column;
    align-items: flex-start;
    gap: 0.75rem;
  }
  
  .results-header > div {
    width: 100%;
  }
  
  .results-header .badge {
    display: inline-block;
    margin-top: 0.5rem;
  }
  
  .table-container {
    padding: 0;
  }
  
  .table {
    font-size: 0.85rem;
    min-width: 550px;
  }
  
  .table thead th {
    padding: 0.5rem 0.25rem;
    font-size: 0.7rem;
  }
  
  .table tbody td {
    padding: 0.5rem 0.25rem;
  }
  
  .team-container {
    flex-direction: column;
    align-items: center;
    gap: 0.25rem;
  }
  
  .team-container.right {
    flex-direction: column;
    align-items: center;
  }
  
  .vs-badge {
    margin: 0.25rem 0;
    width: 25px;
    height: 25px;
    font-size: 0.6rem;
  }
  
  .stat-card {
    min-width: 100%;
    margin: 0.25rem 0;
  }
  
  .court-badge {
    font-size: 0.7rem;
    padding: 0.2rem 0.4rem;
  }
  
  .team-label {
    font-size: 0.75rem;
    padding: 0.2rem 0.4rem;
  }
  
  .call-checkbox {
    transform: scale(1.4);
  }
  
  .empty-state {
    padding: 1.5rem 0.5rem;
  }
  
  .empty-icon {
    font-size: 2.5rem;
  }
  
  .empty-text {
    font-size: 0.9rem;
  }
}

@media (max-width: 576px) {
  .app-container {
    padding: 0.25rem;
  }
  
  .header-section,
  .config-card {
    margin-left: 0.25rem;
    margin-right: 0.25rem;
  }
  
  .table {
    min-width: 400px;
    font-size: 0.8rem;
  }
  
  .table thead th {
    font-size: 0.65rem;
    padding: 0.4rem 0.2rem;
  }
  
  .table tbody td {
    padding: 0.4rem 0.2rem;
  }
  
  .team-label {
    font-size: 0.7rem;
  }
  
  .court-badge {
    font-size: 0.65rem;
  }
  
  .vs-badge {
    width: 22px;
    height: 22px;
    font-size: 0.55rem;
  }
  
  h1 {
    font-size: 1.3rem;
  }
  
  .form-label {
    font-size: 0.85rem;
  }
  
  .form-control {
    font-size: 0.9rem;
  }
}

/* 横向きスマートフォン対応 */
@media (max-width: 768px) and (orientation: landscape) {
  .app-container {
    padding: 0.5rem;
  }
  
  .header-section {
    padding: 0.75rem;
    margin-bottom: 0.75rem;
  }
  
  h1 {
    font-size: 1.4rem;
    margin-bottom: 0.5rem;
  }
  
  .config-card {
    padding: 0.75rem;
  }
  
  .empty-state {
    padding: 1rem 0.5rem;
  }
}

/* タッチデバイス用の調整 */
@media (hover: none) and (pointer: coarse) {
  .btn:hover {
    transform: none;
    box-shadow: none;
  }
  
  .config-card:hover {
    transform: none;
  }
  
  .table tbody tr:hover {
    background-color: transparent;
  }
  
  .call-checkbox {
    min-width: 16px;
    min-height: 16px;
  }
}

/* 高解像度ディスプレイ対応 */
@media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
  .header-section::before {
    width: 6px;
  }
  
  h1::after {
    height: 3px;
  }
}
  </style>
</head>
<body>
  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
  </div>
  
  <div class="app-container container">
    <div class="header-section">
      <h1><i class="fas fa-table-tennis fa-sm"></i> Round Generator</h1>
      <p class="text-muted">テニス・バドミントンなどのラウンディングを効率的に生成するツール</p>
    </div>

    <div class="config-card">
      <h5 class="mb-3"><i class="fas fa-cog fa-sm"></i> 設定</h5>
      
      <!-- 入力フォーム -->
      <form id="configForm" class="row g-3 align-items-end">
        <div class="col-md-3 col-sm-6">
          <label for="inpPlayers" class="form-label">
            シングル人数
            <span class="tooltip-icon" title="個人参加者の人数">
              <i class="fas fa-question-circle"></i>
            </span>
          </label>
          <div class="input-group">
            <span class="input-group-text"><i class="fas fa-user"></i></span>
            <input type="number" class="form-control" id="inpPlayers" value="10" min="0">
          </div>
        </div>
        <div class="col-md-3 col-sm-6">
          <label for="inpTeams" class="form-label">
            固定ペア数
            <span class="tooltip-icon" title="既に組まれたペアの数">
              <i class="fas fa-question-circle"></i>
            </span>
          </label>
          <div class="input-group">
            <span class="input-group-text"><i class="fas fa-users"></i></span>
            <input type="number" class="form-control" id="inpTeams" value="0" min="0">
          </div>
        </div>
        <div class="col-md-3 col-sm-6">
          <label for="inpCourts" class="form-label">
            コート数
            <span class="tooltip-icon" title="利用可能なコート数">
              <i class="fas fa-question-circle"></i>
            </span>
          </label>
          <div class="input-group">
            <span class="input-group-text"><i class="fas fa-vector-square"></i></span>
            <input type="number" class="form-control" id="inpCourts" value="2" min="1">
          </div>
        </div>
        <div class="col-md-3 col-sm-6">
          <label for="inpRounds" class="form-label">
            最大ラウンド数
            <span class="tooltip-icon" title="生成する最大のラウンド数">
              <i class="fas fa-question-circle"></i>
            </span>
          </label>
          <div class="input-group">
            <span class="input-group-text"><i class="fas fa-repeat"></i></span>
            <input type="number" class="form-control" id="inpRounds" value="50" min="1">
          </div>
        </div>
        <div class="col-12 mt-4">
          <button type="button" id="btnGen" class="btn btn-primary">
            <i class="fas fa-play btn-icon"></i>ラウンド生成
          </button>
          <button type="button" id="btnReset" class="btn btn-secondary ms-md-2">
            <i class="fas fa-undo btn-icon"></i>チェック解除
          </button>
        </div>
      </form>
    </div>

    <!-- 結果表示エリア -->
    <div id="outputArea" class="mt-4">
      <div class="empty-state">
        <div class="empty-icon">
          <i class="fas fa-table-tennis"></i>
        </div>
        <div class="empty-text">
          「ラウンド生成」ボタンをクリックして、試合組み合わせを生成してください。
        </div>
        <button type="button" id="btnGuide" class="btn btn-outline-primary">
          <i class="fas fa-info-circle btn-icon"></i>使い方ガイド
        </button>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS (Popper+Bundle) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <!-- ツールチップ初期化 -->
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const tooltips = document.querySelectorAll('[title]');
    tooltips.forEach(el => {
      new bootstrap.Tooltip(el);
    });
  });
  </script>
  <script>
  // 組み合わせ生成ユーティリティ
  // function combinations(arr, k) {
  //   const result = [];
  //   const combo = (start, path) => {
  //     if (path.length === k) {
  //       result.push([...path]);
  //       return;
  //     }
  //     for (let i = start; i < arr.length; i++) {
  //       path.push(arr[i]);
  //       combo(i + 1, path);
  //       path.pop();
  //     }
  //   };
  //   combo(0, []);
  //   return result;
  // }

  // 配列を一意な文字列に変換
  function arrayKey(arr) {
    return [...arr].sort((x, y) => x - y).join(',');
  }

  class RoundGenerator {
    constructor(numPlayers, numCourts = 2, maxRounds = 100, numTeams = 0) {
      // 固定ペア設定
      this.fixedPairs = [];
      for (let i = 1; i <= numTeams * 2; i += 2) {
        this.fixedPairs.push([i, i + 1]);
      }
      
      this.numPlayers = numPlayers + numTeams * 2;
      this.numCourts = numCourts;
      this.maxRounds = maxRounds;
      
      // プレイヤーごとの試合数
      this.playerMatches = {};
      for (let p = 1; p <= this.numPlayers; p++) {
        this.playerMatches[p] = 0;
      }
      
      // ペア使用履歴（ペア → 使用回数）
      this.pairHistory = new Map();
      
      // 対戦履歴（プレイヤー同士 → 対戦回数）
      this.opponentHistory = new Map();
      
      // 全ての可能な組み合わせを事前生成
      this.allCombinations = this._generateAllCombinations();
      
      this.rounds = [];
    }

    // 固定ペアかどうか判定
    _isFixedPair(p1, p2) {
      return this.fixedPairs.some(pair => 
        (pair[0] === p1 && pair[1] === p2) || (pair[0] === p2 && pair[1] === p1)
      );
    }

    // 全ての可能な組み合わせを生成
    _generateAllCombinations() {
      const players = Array.from({length: this.numPlayers}, (_, i) => i + 1);
      const combinations = [];
      
      // 4人の組み合わせを全て生成
      for (const fourPlayers of this._getCombinations(players, 4)) {
        // 固定ペアの制約チェック
        if (!this._isValidFourPlayers(fourPlayers)) continue;
        
        // 4人を2つのペアに分ける全パターン
        const pairings = this._getPairings(fourPlayers);
        for (const [team1, team2] of pairings) {
          // 固定ペア制約チェック
          if (this._isValidPairing(team1, team2)) {
            combinations.push({
              players: new Set(fourPlayers),
              team1: team1.sort((a, b) => a - b),
              team2: team2.sort((a, b) => a - b)
            });
          }
        }
      }
      
      return combinations;
    }

    _getCombinations(arr, k) {
      if (k === 0) return [[]];
      if (arr.length === 0) return [];
      
      const [first, ...rest] = arr;
      const withFirst = this._getCombinations(rest, k - 1).map(combo => [first, ...combo]);
      const withoutFirst = this._getCombinations(rest, k);
      
      return [...withFirst, ...withoutFirst];
    }

    // 4人の組み合わせが有効かチェック（固定ペアの片方だけが含まれていないか）
    _isValidFourPlayers(fourPlayers) {
      const playerSet = new Set(fourPlayers);
      
      for (const [p1, p2] of this.fixedPairs) {
        const hasP1 = playerSet.has(p1);
        const hasP2 = playerSet.has(p2);
        
        // 固定ペアの片方だけが含まれている場合は無効
        if (hasP1 !== hasP2) {
          return false;
        }
      }
      
      return true;
    }

    // 4人を2つのペアに分ける
    _getPairings(fourPlayers) {
      const [p1, p2, p3, p4] = fourPlayers;
      return [
        [[p1, p2], [p3, p4]],
        [[p1, p3], [p2, p4]],
        [[p1, p4], [p2, p3]]
      ];
    }

    // ペアの組み合わせが有効かチェック
    _isValidPairing(team1, team2) {
      // 固定ペアは必ず一緒になる
      for (const [p1, p2] of this.fixedPairs) {
        const team1HasBoth = team1.includes(p1) && team1.includes(p2);
        const team2HasBoth = team2.includes(p1) && team2.includes(p2);
        const team1HasOne = team1.includes(p1) || team1.includes(p2);
        const team2HasOne = team2.includes(p1) || team2.includes(p2);
        
        // 固定ペアが分かれている場合は無効
        if (team1HasOne && team2HasOne && !team1HasBoth && !team2HasBoth) {
          return false;
        }
      }
      
      return true;
    }

    // 組み合わせのスコアを計算（低いほど良い）
    _calculateScore(combination, prevRoundPlayers) {
      let score = 0;
      const {players, team1, team2} = combination;
      
      // 1. プレイヤーの試合数の不均衡ペナルティ
      const matchCounts = [...players].map(p => this.playerMatches[p]);
      const minMatches = Math.min(...matchCounts);
      const maxMatches = Math.max(...matchCounts);
      score += maxMatches * 100; //試合数が多い人がいる組み合わせの優先度を下げる
      score += minMatches * 10; // 試合数が少ない人を優先
      
      // 2. 直前ラウンドのプレイヤー重複ペナルティ
      if (prevRoundPlayers) {
        const overlap = [...players].filter(p => prevRoundPlayers.has(p)).length;
        score += overlap * 50;
      }
      
      // 3. ペア再利用ペナルティ
      const team1Key = arrayKey(team1);
      const team2Key = arrayKey(team2);
      
      // 固定ペア以外の再利用にペナルティ
      if (!this._isFixedPair(team1[0], team1[1])) {
        score += (this.pairHistory.get(team1Key) || 0) * 200;
      }
      if (!this._isFixedPair(team2[0], team2[1])) {
        score += (this.pairHistory.get(team2Key) || 0) * 200;
      }
      
      // 4. 対戦相手再利用ペナルティ
      for (const p1 of team1) {
        for (const p2 of team2) {
          const opponentKey = arrayKey([p1, p2]);
          score += (this.opponentHistory.get(opponentKey) || 0) * 30;
        }
      }
      
      return score;
    }

    // ラウンドの組み合わせを選択
    _selectRoundCombinations(prevRoundPlayers) {
      const selectedCombinations = [];
      const usedPlayers = new Set();
      
      // 各コートに対して最適な組み合わせを選択
      for (let court = 0; court < this.numCourts; court++) {
        let bestCombination = null;
        let bestScore = Infinity;
        
        // 使用されていないプレイヤーのみを含む組み合わせを評価
        for (const combination of this.allCombinations) {
          // 既に使用されているプレイヤーが含まれている場合はスキップ
          if ([...combination.players].some(p => usedPlayers.has(p))) {
            continue;
          }
          
          const score = this._calculateScore(combination, prevRoundPlayers);
          
          if (score < bestScore) {
            bestScore = score;
            bestCombination = combination;
          }
        }
        
        if (bestCombination) {
          selectedCombinations.push(bestCombination);
          // 使用されたプレイヤーを記録
          bestCombination.players.forEach(p => usedPlayers.add(p));
        } else {
          // 組み合わせが見つからない場合は終了
          break;
        }
      }
      
      return selectedCombinations;
    }

    // 履歴を更新
    _updateHistory(combinations) {
      for (const {team1, team2} of combinations) {
        // プレイヤーの試合数を増加
        [...team1, ...team2].forEach(p => {
          this.playerMatches[p]++;
        });
        
        // ペア履歴を更新（固定ペア以外）
        if (!this._isFixedPair(team1[0], team1[1])) {
          const team1Key = arrayKey(team1);
          this.pairHistory.set(team1Key, (this.pairHistory.get(team1Key) || 0) + 1);
        }
        if (!this._isFixedPair(team2[0], team2[1])) {
          const team2Key = arrayKey(team2);
          this.pairHistory.set(team2Key, (this.pairHistory.get(team2Key) || 0) + 1);
        }
        
        // 対戦履歴を更新
        for (const p1 of team1) {
          for (const p2 of team2) {
            const opponentKey = arrayKey([p1, p2]);
            this.opponentHistory.set(opponentKey, (this.opponentHistory.get(opponentKey) || 0) + 1);
          }
        }
      }
    }

    // メイン生成関数
    generate() {
      if (this.numPlayers < this.numCourts * 4) {
        throw new Error("プレイヤー数が不足しています");
      }
      
      let prevRoundPlayers = null;
      
      for (let round = 0; round < this.maxRounds; round++) {
        const combinations = this._selectRoundCombinations(prevRoundPlayers);
        
        if (combinations.length === 0) {
          break; // 組み合わせが見つからない場合は終了
        }
        
        // 履歴を更新
        this._updateHistory(combinations);
        
        // ラウンド結果を保存
        const roundResult = combinations.map(({team1, team2}) => [team1, team2]);
        this.rounds.push(roundResult);
        
        // 次のラウンドのために今回使用したプレイヤーを記録
        prevRoundPlayers = new Set();
        combinations.forEach(({players}) => {
          players.forEach(p => prevRoundPlayers.add(p));
        });
      }
      
      return this.rounds;
    }

    // 統計情報を取得
    getStats() {
      const playerMatches = Object.values(this.playerMatches);
      const minMatches = Math.min(...playerMatches);
      const maxMatches = Math.max(...playerMatches);
      const avgMatches = playerMatches.reduce((a, b) => a + b, 0) / playerMatches.length;

      return {
        totalRounds: this.rounds.length,
        totalMatches: this.rounds.length * this.numCourts,
        minPlayerMatches: minMatches,
        maxPlayerMatches: maxMatches,
        avgPlayerMatches: avgMatches.toFixed(1),
        playerMatchDistribution: this._getMatchDistribution(),
      };
    }

    _getMatchDistribution() {
      const distribution = {};
      Object.values(this.playerMatches).forEach(count => {
        distribution[count] = (distribution[count] || 0) + 1;
      });

      const labels = [];
      const data = [];
      const maxCount = Math.max(...Object.keys(distribution).map(Number));
      
      for (let i = 0; i <= maxCount; i++) {
        labels.push(i.toString());
        data.push(distribution[i] || 0);
      }

      return { labels, data };
    }
  }


  // ==== DOM 操作 ====
  const btnGen    = document.getElementById('btnGen');
  const btnReset  = document.getElementById('btnReset');
  const output    = document.getElementById('outputArea');
  const loadingOverlay = document.getElementById('loadingOverlay');

  btnGen.addEventListener('click', ()=>{
    const s  = parseInt(document.getElementById('inpPlayers').value,10);
    const t  = parseInt(document.getElementById('inpTeams').value,10);
    const c  = parseInt(document.getElementById('inpCourts').value,10);
    const mr = parseInt(document.getElementById('inpRounds').value,10);

    // ローディング表示
    loadingOverlay.classList.add('show');
    
    // 非同期処理
    setTimeout(() => {
      output.innerHTML = '';
      
      // try {
        const rg = new RoundGenerator(s, c, mr, t);
        const rounds = rg.generate();
        const stats = rg.getStats();
  
        // 固定ペアラベル A,B,C...
        const fixedLabel = {};
        rg.fixedPairs.forEach((pair, idx)=>{
          fixedLabel[pair.join(',')] = String.fromCharCode(65 + idx);
        });
        
        // 結果カードを作成
        const resultsCard = document.createElement('div');
        resultsCard.className = 'results-card';
        
        // カードヘッダー
        const resultsHeader = document.createElement('div');
        resultsHeader.className = 'results-header';
        resultsHeader.innerHTML = `
          <div>
            <i class="fas fa-trophy me-2"></i>
            生成結果: ${stats.totalRounds}ラウンド (${stats.totalMatches}試合)
          </div>
          <div>
            <span class="badge bg-light text-dark">
              <i class="fas fa-user me-1"></i>参加者: ${rg.numPlayers}人
            </span>
          </div>
        `;
        resultsCard.appendChild(resultsHeader);
        
        // テーブルコンテナ
        const tableContainer = document.createElement('div');
        tableContainer.className = 'table-container';
        
        const tbl = document.createElement('table');
        tbl.className = 'table table-hover';
        tbl.innerHTML = `
          <thead>
            <tr>
              <th style="width:100px;">完了</th>
              <!-- <th style="width:80px;">ラウンド</th> -->
              <th style="width:180px;">コート</th>
              <th class="text-end">Team 1</th>
              <th class="text-center" style="width:80px;">vs</th>
              <th class="text-start">Team 2</th>
            </tr>
          </thead>
          <tbody>
            ${rounds.map((matches, ri)=>{
              return matches.map((pair, ci)=>{
                const [t1,t2] = pair;
                const k1 = t1.join(','), k2 = t2.join(',');
                const l1 = fixedLabel[k1] || `${t1.map(p => `<div class="d-inline-block mx-2"><span class="badge bg-light text-dark fs-3">${p}</span></div>`).join('')}`;
                const l2 = fixedLabel[k2] || `${t2.map(p => `<div class="d-inline-block mx-2"><span class="badge bg-light text-dark fs-3">${p}</span></div>`).join('')}`;
                return `
                <tr>
                  <td><input type="checkbox" class="call-checkbox"></td>
                  <!-- <td><span class="round-badge">${ri+1}</span></td> -->
                  <td><span class="court-badge fs-4"><span class="d-none d-md-inline"><i class="fas fa-table-tennis me-1"></i>コート</span> ${ci+1}</span></td>
                  <td>
                    <div class="team-container">
                      <div class="team-label">${l1}</div>
                    </div>
                  </td>
                  <td class="text-center"><div class="vs-badge">VS</div></td>
                  <td>
                    <div class="team-container right">
                      <div class="team-label">${l2}</div>
                    </div>
                  </td>
                </tr>`;
              }).join('');
            }).join('')}
          </tbody>
        `;
        tableContainer.appendChild(tbl);
        resultsCard.appendChild(tableContainer);
        
        output.appendChild(resultsCard);
        
        // アニメーションでカードを表示
        setTimeout(() => {
          resultsCard.classList.add('show');
        }, 100);
        
        
        // チェックボックスイベント設定
        document.querySelectorAll('.call-checkbox').forEach(cb => {
          cb.addEventListener('change', function() {
            const row = this.closest('tr');
            if (this.checked) {
              row.classList.add('completed');
            } else {
              row.classList.remove('completed');
            }
          });
        });
        
      // } catch(e) {
      //   const alert = document.createElement('div');
      //   alert.className = 'alert alert-danger';
      //   alert.innerHTML = `<i class="fas fa-exclamation-circle alert-icon"></i> エラー: ${e.message}`;
      //   output.appendChild(alert);
        
      //   // エラー時は空の状態を表示
      //   const emptyState = document.createElement('div');
      //   emptyState.className = 'empty-state';
      //   emptyState.innerHTML = `
      //     <div class="empty-icon">
      //       <i class="fas fa-exclamation-triangle"></i>
      //     </div>
      //     <div class="empty-text">
      //       設定を見直して、もう一度試してください。
      //     </div>
      //   `;
      //   output.appendChild(emptyState);
      // }
      
      // ローディング非表示
      loadingOverlay.classList.remove('show');
      
    }, 800); // 処理遅延時間（アニメーション用）
  });

  btnReset.addEventListener('click', ()=>{
    document.querySelectorAll('.call-checkbox')
            .forEach(cb => {
              cb.checked = false;
              const row = cb.closest('tr');
              if (row) row.classList.remove('completed');
            });
  });
  
  // 使い方ガイド
  document.getElementById('btnGuide').addEventListener('click', () => {
    const guideHTML = `
      <div class="modal fade" id="guideModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header bg-primary text-white">
              <h5 class="modal-title"><i class="fas fa-book me-2"></i>Round Generator 使い方ガイド</h5>
              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="row">
                <div class="col-md-6">
                  <h6><i class="fas fa-cog me-2"></i>基本設定</h6>
                  <ul class="list-group list-group-flush mb-4">
                    <li class="list-group-item"><strong>シングル人数</strong>: 個人参加者の人数</li>
                    <li class="list-group-item"><strong>固定ペア数</strong>: 既に組まれたペアの数</li>
                    <li class="list-group-item"><strong>コート数</strong>: 利用可能なコート数</li>
                    <li class="list-group-item"><strong>最大ラウンド数</strong>: 生成するラウンドの上限</li>
                  </ul>
                </div>
                <div class="col-md-6">
                  <h6><i class="fas fa-lightbulb me-2"></i>ヒント</h6>
                  <ul class="list-group list-group-flush mb-4">
                    <li class="list-group-item">総プレイヤー数はコート数×4以上必要です</li>
                    <li class="list-group-item">固定ペアは常にペアを組みます</li>
                    <li class="list-group-item">チェックボックスで試合完了状態を管理できます</li>
                  </ul>
                </div>
              </div>
              
              <div class="alert alert-info mt-3">
                <i class="fas fa-info-circle me-2"></i>
                このツールは、すべての参加者が均等に試合に参加できるよう最適化されています。
                固定ペアは常にペアを組み、シングル参加者は様々な相手と組み合わされます。
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-primary" data-bs-dismiss="modal">理解しました</button>
            </div>
          </div>
        </div>
      </div>
    `;
    
    // モーダルをDOMに追加して表示
    document.body.insertAdjacentHTML('beforeend', guideHTML);
    const modal = new bootstrap.Modal(document.getElementById('guideModal'));
    modal.show();
    
    // モーダルが閉じられたときにDOMから削除
    document.getElementById('guideModal').addEventListener('hidden.bs.modal', function () {
      this.remove();
    });
  });
  </script>
</body>
</html>